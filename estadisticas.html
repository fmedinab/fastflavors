<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estad√≠sticas de Reservas - Fast Flavors</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .stats-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .stats-header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--primary-color);
      color: white;
      border-radius: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-card h3 {
      color: var(--primary-color);
      margin: 0 0 10px 0;
      font-size: 1.2rem;
    }

    .stat-number {
      font-size: 3rem;
      font-weight: bold;
      color: var(--secondary-color);
      margin: 10px 0;
    }

    .stat-label {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .table-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow-x: auto;
      margin-bottom: 30px;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
    }

    .stats-table th,
    .stats-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .stats-table th {
      background: var(--primary-color);
      color: white;
      font-weight: bold;
    }

    .stats-table tr:hover {
      background: #f5f5f5;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
    }

    .badge-manana {
      background: #fff3cd;
      color: #856404;
    }

    .badge-tarde {
      background: #d1ecf1;
      color: #0c5460;
    }

    .btn-refresh {
      background: var(--secondary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      margin: 10px 5px;
    }

    .btn-refresh:hover {
      background: var(--primary-color);
    }

    .btn-back {
      background: var(--text-light);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      margin: 10px 5px;
      text-decoration: none;
      display: inline-block;
    }

    .btn-back:hover {
      background: #555;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-light);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
    }

    .empty-state .icon-empty {
      font-size: 4rem;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="stats-container">
    <div class="stats-header">
      <h1>üìä Estad√≠sticas de Reservas</h1>
      <p>Panel de control para administradores</p>
      <div>
        <button class="btn-refresh" onclick="cargarEstadisticas()">üîÑ Actualizar</button>
        <a href="index.html" class="btn-back">‚Üê Volver al men√∫</a>
      </div>
    </div>

    <!-- Estad√≠sticas de HOY -->
    <div id="estadisticasHoy" class="stats-grid">
      <div class="stat-card">
        <h3>üçΩÔ∏è Reservas Hoy</h3>
        <div class="stat-number" id="totalHoy">-</div>
        <div class="stat-label">Estudiantes</div>
      </div>
      <div class="stat-card">
        <h3>üì¶ Platos Totales</h3>
        <div class="stat-number" id="totalPlatos">-</div>
        <div class="stat-label">Platos reservados</div>
      </div>
      <div class="stat-card">
        <h3>üí∞ Ingresos Hoy</h3>
        <div class="stat-number" id="totalIngresos">-</div>
        <div class="stat-label">Soles</div>
      </div>
      <div class="stat-card">
        <h3>üåÖ Turno Ma√±ana</h3>
        <div class="stat-number" id="totalManana">-</div>
        <div class="stat-label">Reservas</div>
      </div>
      <div class="stat-card">
        <h3>üåÜ Turno Tarde</h3>
        <div class="stat-number" id="totalTarde">-</div>
        <div class="stat-label">Reservas</div>
      </div>
      <div class="stat-card">
        <h3>üìà Total General</h3>
        <div class="stat-number" id="totalGeneral">-</div>
        <div class="stat-label">Todas las reservas</div>
      </div>
    </div>

    <!-- Tabla de √∫ltimos 7 d√≠as -->
    <div class="table-container">
      <h2>üìÖ √öltimos 7 D√≠as</h2>
      <table class="stats-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>D√≠a</th>
            <th>üåÖ Ma√±ana</th>
            <th>üåÜ Tarde</th>
            <th>üìä Total</th>
          </tr>
        </thead>
        <tbody id="tabla7Dias">
          <tr>
            <td colspan="5" class="loading">Cargando...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Detalle de reservas de HOY -->
    <div class="table-container">
      <h2>üìã Detalle de Reservas de Hoy</h2>
      <table class="stats-table">
        <thead>
          <tr>
            <th>Hora</th>
            <th>Turno</th>
            <th>Estudiante</th>
            <th>C√≥digo</th>
            <th>Plato</th>
            <th>Cant.</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="tablaDetalleHoy">
          <tr>
            <td colspan="7" class="loading">Cargando...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Platos m√°s solicitados HOY -->
    <div class="table-container">
      <h2>üèÜ Platos M√°s Solicitados Hoy</h2>
      <table class="stats-table">
        <thead>
          <tr>
            <th>Plato</th>
            <th>Cantidad</th>
            <th>Porcentaje</th>
          </tr>
        </thead>
        <tbody id="tablaPlatosPopulares">
          <tr>
            <td colspan="3" class="loading">Cargando...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script>
    // Cargar estad√≠sticas al iniciar
    document.addEventListener('DOMContentLoaded', () => {
      cargarEstadisticas();
    });

    async function cargarEstadisticas() {
      try {
        Utils.showLoader();

        // Obtener resumen general
        const resumen = await api.getEstadisticasResumen();
        const dataResumen = resumen.data || resumen;

        // Obtener estad√≠sticas de hoy
        const estadisticasHoy = await api.getEstadisticas();
        const dataHoy = estadisticasHoy.data || estadisticasHoy;

        // Actualizar cards de resumen
        document.getElementById('totalHoy').textContent = dataHoy.totalReservas || 0;
        document.getElementById('totalPlatos').textContent = dataHoy.totalPlatos || 0;
        document.getElementById('totalIngresos').textContent = 'S/ ' + (dataHoy.totalIngresos || 0).toFixed(2);
        document.getElementById('totalManana').textContent = dataHoy.reservasPorTurno?.MANANA || 0;
        document.getElementById('totalTarde').textContent = dataHoy.reservasPorTurno?.TARDE || 0;
        document.getElementById('totalGeneral').textContent = dataResumen.totalGeneral || 0;

        // Renderizar tabla de √∫ltimos 7 d√≠as
        renderTabla7Dias(dataResumen.ultimos7Dias);

        // Renderizar detalle de hoy
        renderDetalleHoy(dataHoy.reservasDetalle);

        // Renderizar platos populares
        renderPlatosPopulares(dataHoy.reservasPorPlato, dataHoy.totalReservas);

      } catch (error) {
        console.error('Error al cargar estad√≠sticas:', error);
        Utils.showToast('Error al cargar estad√≠sticas', 'error');
      } finally {
        Utils.hideLoader();
      }
    }

    function renderTabla7Dias(datos) {
      const tbody = document.getElementById('tabla7Dias');
      
      if (!datos || datos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No hay datos disponibles</td></tr>';
        return;
      }

      tbody.innerHTML = datos.map(dia => `
        <tr>
          <td><strong>${dia.fecha}</strong></td>
          <td>${dia.dia}</td>
          <td><span class="badge badge-manana">${dia.manana}</span></td>
          <td><span class="badge badge-tarde">${dia.tarde}</span></td>
          <td><strong>${dia.total}</strong></td>
        </tr>
      `).join('');
    }

    function renderDetalleHoy(reservas) {
      const tbody = document.getElementById('tablaDetalleHoy');
      
      if (!reservas || reservas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="icon-empty">üì≠</div><p>No hay reservas para hoy</p></td></tr>';
        return;
      }

      tbody.innerHTML = reservas.map(r => `
        <tr>
          <td>${r.hora}</td>
          <td><span class="badge badge-${r.turno.toLowerCase()}">${r.turno}</span></td>
          <td>${r.estudiante}</td>
          <td>${r.codigo}</td>
          <td>${r.plato}</td>
          <td><strong>${r.cantidad || 1}</strong></td>
          <td>S/ ${(r.precioTotal || 0).toFixed(2)}</td>
        </tr>
      `).join('');
    }

    function renderPlatosPopulares(platos, total) {
      const tbody = document.getElementById('tablaPlatosPopulares');
      
      if (!platos || Object.keys(platos).length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No hay datos disponibles</td></tr>';
        return;
      }

      // Convertir objeto a array y ordenar por cantidad
      const platosArray = Object.entries(platos)
        .map(([nombre, cantidad]) => ({
          nombre,
          cantidad,
          porcentaje: total > 0 ? ((cantidad / total) * 100).toFixed(1) : 0
        }))
        .sort((a, b) => b.cantidad - a.cantidad);

      tbody.innerHTML = platosArray.map((plato, index) => `
        <tr>
          <td>${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üìå'} ${plato.nombre}</td>
          <td><strong>${plato.cantidad}</strong></td>
          <td>${plato.porcentaje}%</td>
        </tr>
      `).join('');
    }
  </script>
</body>
</html>
